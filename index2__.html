<html>
    <head>
        <title>game4</title>
        <!--<script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>-->
        <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
        <script type="text/javascript" src="jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="utils.js"></script>
        <link rel="Stylesheet" type="text/css" href="style.css" />

        <script>

            var preload;
            var canvas, stage;
            //var drawingCanvas;
            var oldPt;
            var oldMidPt;
            var brush;
            
            function updateLoading() {
                messageField.text = "Loading " + (preload.progress * 100 | 0) + "%";
                stage.update();
            }

            function init() {
                if (!createjs.Sound.initializeDefaultPlugins()) {
                    document.getElementById("error").style.display = "block";
                    document.getElementById("content").style.display = "none";
                    return;
                }
                canvas = document.getElementById("gameCanvas");
                stage = new createjs.Stage(canvas);
                //stage.autoClear = false;
                stage.enableDOMEvents(true);

                stage.addEventListener("stagemousedown", handleMouseDown);
                stage.addEventListener("stagemouseup", handleMouseUp);
                stage.addEventListener("stagemousemove", handleMouseMove);
                
                messageField = new createjs.Text("Loading", "bold 24px Arial", "#000000");
                messageField.maxWidth = 1000;
                messageField.textAlign = "center";
                messageField.textBaseline = "middle";
                messageField.x = canvas.width / 2;
                messageField.y = canvas.height / 2;
                stage.addChild(messageField);
                stage.update(); 	//update the stage to show text

                fpsLabel = new createjs.Text("-- fps", "bold 18px Arial", "#000");
                stage.addChild(fpsLabel);
                fpsLabel.x = 200;
                fpsLabel.y = 160;

                createjs.Ticker.timingMode = createjs.Ticker.RAF;
                createjs.Ticker.addEventListener("tick", updateScene);

                messageField.text = "Press space to play.";

                oldPt = new createjs.Point(-1,-1);
                oldMidPt = oldPt.clone();
                
                brush = new createjs.Bitmap("gfx/10.png"); 
                brush.regX = brush.image.width / 2;
                brush.regY = brush.image.height / 2;
                brush.x = 0;
                brush.y = 0;
                //brush.color = "#00ff00";
                brush.cache(0,0,brush.image.width,brush.image.height);
                //brush.uncache();
                brush.filters = [
                    new createjs.ColorFilter(0,1,0,1, 0,0,0,0)
                ];
                stage.addChild(brush);
                
                stage.update();
            }

            var fpsLabel;
            var fps = 0;
            var lt;

            function updateScene(event) {
                fpsLabel.text = Math.round(createjs.Ticker.getMeasuredFPS()) + " fps";

                var ct = createjs.Ticker.getTime();
                var dt = ct - lt;
                lt = ct;

                brush.updateCache();
                
                if (isNaN(dt))
                    return;
                stage.update();
            }
            
            function handleMouseDown(event) {
                if (!event.primary) { return; }
                oldPt = new createjs.Point(stage.mouseX, stage.mouseY);
                oldMidPt = oldPt.clone();
                messageField.text = "x: " + oldPt.x + " y: " + oldPt.y;                
            }

            function handleMouseMove(event) {
                if (!event.primary) { return; }
                var midPt = new createjs.Point(oldPt.x + stage.mouseX >> 1, oldPt.y + stage.mouseY >> 1);

                //drawingCanvas.graphics.clear().setStrokeStyle(stroke, 'round', 'round').beginStroke(color).moveTo(midPt.x, midPt.y).curveTo(oldPt.x, oldPt.y, oldMidPt.x, oldMidPt.y);

                oldPt.x = stage.mouseX;
                oldPt.y = stage.mouseY;
                messageField.text = "x: " + oldPt.x + " y: " + oldPt.y;
                
                oldMidPt.x = midPt.x;
                oldMidPt.y = midPt.y;

                brush.x = oldMidPt.x;
                brush.y = oldMidPt.y;
                
                stage.update();
            }

            function handleMouseUp(event) {
                if (!event.primary) { return; }
                //stage.removeEventListener("stagemousemove", handleMouseMove);
            }
        </script>

    </head>
    <body onload="init();" style="background-color: black; text-align: center">
        <div id="all">
            <canvas id="gameCanvas" style="background-color: brown;" width="500" height="600"></canvas>
            <div id="log" style="background-color: white; margin-top: 20px;">Log</div>
        </div>
    </body>
</html>